name: Test Workflow

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

        # Set up NX caching to speed up the CI process
      - name: Set up NX caching
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            dist
            tmp
          key: ${{ runner.os }}-nx-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nx-

       # Run the breaking changes detection script       
      - name: Run API Breaking Change Detection for Affected Projects
        run: |
          node .github/workflows/scripts/detect-breaking-changes.js

      # Save NX Cache (optional, can improve performance)
      - name: Save NX Cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            dist
            tmp
          key: ${{ runner.os }}-nx-${{ hashFiles('**/package-lock.json') }}
          
      - name: Run tests
        run: echo "Running tests locally!"
